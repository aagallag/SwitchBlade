/*
* Copyright (c) 2018 naehrwert
*
* This program is free software; you can redistribute it and/or modify it
* under the terms and conditions of the GNU General Public License,
* version 2, as published by the Free Software Foundation.
*
* This program is distributed in the hope it will be useful, but WITHOUT
* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
* FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
* more details.
*
* You should have received a copy of the GNU General Public License
* along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

#include <stdarg.h>
#include "gfx.h"

static const u8 _gfx_font[] = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x1E, 0x58, 0x40, 0x00, 0x00,
	0x00, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x0E, 0x00, 0x28, 0xFE, 0xFE, 0x28, 0x28, 0xFE, 0xFE, 0x28,
	0x00, 0x24, 0x74, 0xD6, 0xD6, 0x5C, 0x48, 0x00, 0x00, 0xC6, 0xCC, 0x19, 0x30, 0x66, 0xC6, 0x00,
	0xA0, 0xE4, 0xEE, 0x9A, 0x9A, 0xFE, 0x64, 0x00, 0x00, 0x00, 0x00, 0x02, 0x06, 0x0C, 0x08, 0x00,
	0x00, 0x00, 0x42, 0x66, 0x3C, 0x18, 0x00, 0x00, 0x00, 0x00, 0x18, 0x3C, 0x66, 0x42, 0x00, 0x00,
	0x08, 0x2A, 0x3E, 0x1C, 0x1C, 0x3E, 0x2A, 0x08, 0x00, 0x08, 0x08, 0x3E, 0x3E, 0x08, 0x08, 0x00,
	0x00, 0x00, 0x00, 0x30, 0x70, 0x40, 0x00, 0x00, 0x00, 0x00, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00,
	0x00, 0x00, 0x00, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x40, 0x00,
	0x00, 0x3C, 0x7E, 0x4A, 0x52, 0x7E, 0x3C, 0x00, 0x00, 0x40, 0x40, 0x7E, 0x7E, 0x44, 0x40, 0x00,
	0x00, 0x44, 0x4E, 0x4A, 0x52, 0x72, 0x64, 0x00, 0x00, 0x34, 0x7E, 0x4A, 0x4A, 0x62, 0x24, 0x00,
	0x10, 0x7E, 0x7E, 0x10, 0x16, 0x1E, 0x18, 0x00, 0x00, 0x3A, 0x7A, 0x4A, 0x4A, 0x6E, 0x2E, 0x00,
	0x00, 0x30, 0x7A, 0x4A, 0x4A, 0x7E, 0x3C, 0x00, 0x00, 0x02, 0x0E, 0x7E, 0x72, 0x02, 0x02, 0x00,
	0x00, 0x34, 0x7E, 0x4A, 0x4A, 0x7E, 0x34, 0x00, 0x00, 0x3C, 0x7E, 0x4A, 0x4A, 0x6E, 0x24, 0x00,
	0x00, 0x00, 0x00, 0x44, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x74, 0x40, 0x00, 0x00,
	0x00, 0x42, 0x42, 0x66, 0x24, 0x3C, 0x18, 0x00, 0x00, 0x00, 0x14, 0x14, 0x14, 0x14, 0x14, 0x00,
	0x00, 0x18, 0x3C, 0x24, 0x66, 0x42, 0x42, 0x00, 0x00, 0x04, 0x0E, 0x5A, 0x52, 0x06, 0x04, 0x00,
	0x00, 0x5C, 0x9E, 0x9A, 0x82, 0xFE, 0x7C, 0x00, 0x00, 0x7C, 0x7E, 0x0A, 0x0A, 0x7E, 0x7C, 0x00,
	0x00, 0x34, 0x7E, 0x4A, 0x4A, 0x7E, 0x7E, 0x00, 0x00, 0x24, 0x66, 0x42, 0x42, 0x7E, 0x3C, 0x00,
	0x00, 0x18, 0x3C, 0x66, 0x42, 0x7E, 0x7E, 0x00, 0x00, 0x42, 0x42, 0x4A, 0x4A, 0x7E, 0x7E, 0x00,
	0x00, 0x00, 0x02, 0x0A, 0x0A, 0x7E, 0x7E, 0x00, 0x00, 0x34, 0x76, 0x52, 0x42, 0x7E, 0x3C, 0x00,
	0x00, 0x7E, 0x7E, 0x08, 0x08, 0x7E, 0x7E, 0x00, 0x00, 0x00, 0x42, 0x7E, 0x7E, 0x42, 0x00, 0x00,
	0x00, 0x02, 0x3E, 0x7E, 0x42, 0x60, 0x20, 0x00, 0x00, 0x42, 0x66, 0x3C, 0x18, 0x7E, 0x7E, 0x00,
	0x00, 0x40, 0x40, 0x40, 0x40, 0x7E, 0x7E, 0x00, 0x00, 0x7E, 0x0C, 0x18, 0x0C, 0x7E, 0x7E, 0x00,
	0x00, 0x7E, 0x7E, 0x18, 0x0C, 0x7E, 0x7E, 0x00, 0x00, 0x3C, 0x7E, 0x42, 0x42, 0x7E, 0x3C, 0x00,
	0x00, 0x04, 0x0E, 0x0A, 0x0A, 0x7E, 0x7E, 0x00, 0x00, 0x5C, 0x7E, 0x62, 0x22, 0x3E, 0x1C, 0x00,
	0x00, 0x44, 0x6E, 0x3A, 0x1A, 0x7E, 0x7E, 0x00, 0x00, 0x24, 0x76, 0x52, 0x4A, 0x6E, 0x24, 0x00,
	0x00, 0x02, 0x02, 0x7E, 0x7E, 0x02, 0x02, 0x00, 0x00, 0x3E, 0x7E, 0x40, 0x40, 0x7E, 0x3E, 0x00,
	0x00, 0x1E, 0x3E, 0x60, 0x60, 0x3E, 0x1E, 0x00, 0x00, 0x7E, 0x30, 0x18, 0x30, 0x7E, 0x7E, 0x00,
	0x00, 0x62, 0x76, 0x1C, 0x1C, 0x76, 0x62, 0x00, 0x00, 0x06, 0x0E, 0x78, 0x78, 0x0E, 0x06, 0x00,
	0x00, 0x42, 0x46, 0x4E, 0x5A, 0x72, 0x62, 0x00, 0x00, 0x00, 0x82, 0x82, 0xFE, 0xFE, 0x00, 0x00,
	0x00, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x02, 0x00, 0x00, 0x00, 0xFE, 0xFE, 0x82, 0x82, 0x00, 0x00,
	0x00, 0x08, 0x0C, 0x06, 0x06, 0x0C, 0x08, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00,
	0x00, 0x00, 0x08, 0x0C, 0x06, 0x02, 0x00, 0x00, 0x00, 0x78, 0x7C, 0x54, 0x54, 0x74, 0x20, 0x00,
	0x00, 0x30, 0x78, 0x48, 0x48, 0x7E, 0x7E, 0x00, 0x00, 0x00, 0x44, 0x44, 0x44, 0x7C, 0x38, 0x00,
	0x00, 0x7E, 0x7E, 0x48, 0x48, 0x78, 0x30, 0x00, 0x00, 0x18, 0x5C, 0x54, 0x54, 0x7C, 0x38, 0x00,
	0x00, 0x00, 0x0A, 0x0A, 0x7E, 0x7C, 0x08, 0x00, 0x00, 0x3C, 0x5C, 0x54, 0x54, 0x5C, 0x08, 0x00,
	0x00, 0x70, 0x78, 0x08, 0x08, 0x7E, 0x7E, 0x00, 0x00, 0x00, 0x40, 0x7A, 0x7A, 0x48, 0x00, 0x00,
	0x00, 0x00, 0x3A, 0x7A, 0x40, 0x40, 0x40, 0x00, 0x00, 0x40, 0x68, 0x38, 0x10, 0x7E, 0x7E, 0x00,
	0x00, 0x00, 0x40, 0x7E, 0x7E, 0x42, 0x00, 0x00, 0x78, 0x7C, 0x1C, 0x38, 0x18, 0x7C, 0x7C, 0x00,
	0x00, 0x78, 0x7C, 0x04, 0x04, 0x7C, 0x7C, 0x00, 0x00, 0x38, 0x7C, 0x44, 0x44, 0x7C, 0x38, 0x00,
	0x00, 0x18, 0x3C, 0x24, 0x24, 0x7C, 0x7C, 0x00, 0x00, 0x7C, 0x7C, 0x24, 0x24, 0x3C, 0x18, 0x00,
	0x00, 0x08, 0x0C, 0x04, 0x04, 0x7C, 0x7C, 0x00, 0x00, 0x24, 0x74, 0x54, 0x54, 0x5C, 0x48, 0x00,
	0x00, 0x44, 0x44, 0x7E, 0x3E, 0x04, 0x04, 0x00, 0x00, 0x7C, 0x7C, 0x40, 0x40, 0x7C, 0x3C, 0x00,
	0x00, 0x1C, 0x3C, 0x60, 0x60, 0x3C, 0x1C, 0x00, 0x1C, 0x7C, 0x70, 0x38, 0x70, 0x7C, 0x1C, 0x00,
	0x00, 0x44, 0x6C, 0x38, 0x38, 0x6C, 0x44, 0x00, 0x00, 0x3C, 0x7C, 0x50, 0x50, 0x5C, 0x0C, 0x00,
	0x00, 0x44, 0x4C, 0x5C, 0x74, 0x64, 0x44, 0x00, 0x00, 0x00, 0x00, 0x04, 0xDC, 0x20, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0xDC, 0x04, 0x00, 0x00,
	0x00, 0x08, 0x10, 0x10, 0x08, 0x08, 0x10, 0x00,
};

void gfx_init_ctxt(gfx_ctxt_t *ctxt, u32 *fb, u32 width, u32 height, u32 stride)
{
	ctxt->fb = fb;
	ctxt->width = width;
	ctxt->height = height;
	ctxt->stride = stride;
}

void gfx_clear(gfx_ctxt_t *ctxt, u32 color)
{
	for (u32 i = 0; i < ctxt->height * ctxt->stride; i++)
		ctxt->fb[i] = color;
}

void gfx_con_init(gfx_con_t *con, gfx_ctxt_t *ctxt)
{
	con->gfx_ctxt = ctxt;
	con->x = 0;
	con->y = 1272;
	con->fgcol = 0xFFFFFFFF;
	con->fillbg = 1;
	con->bgcol = 0xFF000000;
	con->prompts_enabled = true;
}

void gfx_con_setcol(gfx_con_t *con, u32 fgcol, int fillbg, u32 bgcol)
{
	con->fgcol = fgcol;
	con->fillbg = fillbg;
	con->bgcol = bgcol;
}

void gfx_con_getpos(gfx_con_t *con, u32 *x, u32 *y)
{
	*x = con->x;
	*y = con->y;
}

void gfx_con_setpos(gfx_con_t *con, u32 x, u32 y)
{
	con->x = x;
	con->y = y;
}

void gfx_putc(gfx_con_t *con, char c)
{
	if (c >= 32 && c <= 126)
	{
		u8 *cbuf = (u8 *)&_gfx_font[8 * (c - 32)];
		u32 *fb = con->gfx_ctxt->fb + con->x + con->y * con->gfx_ctxt->stride;
		for (u32 i = 0; i < 8; i++)
		{
			u8 v = *cbuf++;
			for (u32 j = 0; j < 8; j++)
			{
				if (v & 1)
					*fb = con->fgcol;
				else if (con->fillbg)
					*fb = con->bgcol;
				v >>= 1;
				fb++;
			}
			fb += con->gfx_ctxt->stride - 8;
		}
		con->x += 8;
	}
	else if (c == '\n')
	{
		con->x += 8;
		con->y = 1272;
		if (con->y > con->gfx_ctxt->width - 8)
			con->y = 0;
	}
}

void gfx_puts(gfx_con_t *con, const char *s)
{
	if (!s)
		return;

	for (; *s; s++)
		gfx_putc(con, *s);
}

static void _gfx_putn(gfx_con_t *con, u32 v, int base, char fill, int fcnt)
{
	char buf[65];
	static const char digits[] = "0123456789ABCDEFghijklmnopqrstuvwxyz";
	char *p;
	int c = fcnt;

	if (base > 36)
		return;

	p = buf + 64;
	*p = 0;
	do
	{
		c--;
		*--p = digits[v % base];
		v /= base;
	} while (v);

	if (fill != 0)
	{
		while (c > 0)
		{
			*--p = fill;
			c--;
		}
	}

	gfx_puts(con, p);
}

void gfx_printf(gfx_con_t *con, const char *fmt, ...)
{
	va_list ap;
	int fill, fcnt;

	va_start(ap, fmt);
	while(*fmt)
	{
		if(*fmt == '%')
		{
			fmt++;
			fill = 0;
			fcnt = 0;
			if ((*fmt >= '0' && *fmt <= '9') || *fmt == ' ')
			{
				fcnt = *fmt;
				fmt++;
				if (*fmt >= '0' && *fmt <= '9')
				{
					fill = fcnt;
					fcnt = *fmt - '0';
					fmt++;
				}
				else
				{
					fill = ' ';
					fcnt -= '0';
				}
			}
			switch(*fmt)
			{
			case 'c':
				gfx_putc(con, va_arg(ap, u32));
				break;
			case 's':
				gfx_puts(con, va_arg(ap, char *));
				break;
			case 'd':
				_gfx_putn(con, va_arg(ap, u32), 10, fill, fcnt);
				break;
			case 'x':
			case 'X':
				_gfx_putn(con, va_arg(ap, u32), 16, fill, fcnt);
				break;
			case 'k':
				con->fgcol = va_arg(ap, u32);
				break;
			case 'K':
				con->bgcol = va_arg(ap, u32);
				con->fillbg = fcnt;
				break;
			case '%':
				gfx_putc(con, '%');
				break;
			case '\0':
				goto out;
			default:
				gfx_putc(con, '%');
				gfx_putc(con, *fmt);
				break;
			}
		}
		else
			gfx_putc(con, *fmt);
		fmt++;
	}

	out:
	va_end(ap);
}

void gfx_prompt(gfx_con_t * con, gfx_prompt_type type, const char *fmt, ...) {
	if (con->prompts_enabled == false) {
		return;
	}

	switch (type) {
		case error:
			gfx_putc(con, '[');
			con->fgcol = 0xFF0000FF;
			gfx_puts(con, "  Error  ");
			con->fgcol = 0xFFFFFFFF;
			gfx_putc(con, ']');
			break;

		case warning:
			gfx_putc(con, '[');
			con->fgcol = 0xFF00FFFF;
			gfx_puts(con, " Warning ");
			con->fgcol = 0xFFFFFFFF;
			gfx_putc(con, ']');
			break;

		case ok:
			gfx_putc(con, '[');
			con->fgcol = 0xFF00FF00;
			gfx_puts(con, "   Ok    ");
			con->fgcol = 0xFFFFFFFF;
			gfx_putc(con, ']');
			break;

		default:
			gfx_printf(con, "            ");
	}

	va_list ap;
	int fill, fcnt;

	va_start(ap, fmt);
	while(*fmt)
	{
		if(*fmt == '%')
		{
			fmt++;
			fill = 0;
			fcnt = 0;
			if ((*fmt >= '0' && *fmt <= '9') || *fmt == ' ')
			{
				fcnt = *fmt;
				fmt++;
				if (*fmt >= '0' && *fmt <= '9')
				{
					fill = fcnt;
					fcnt = *fmt - '0';
					fmt++;
				}
				else
				{
					fill = ' ';
					fcnt -= '0';
				}
			}
			switch(*fmt)
			{
			case 'c':
				gfx_putc(con, va_arg(ap, u32));
				break;
			case 's':
				gfx_puts(con, va_arg(ap, char *));
				break;
			case 'd':
				_gfx_putn(con, va_arg(ap, u32), 10, fill, fcnt);
				break;
			case 'x':
			case 'X':
				_gfx_putn(con, va_arg(ap, u32), 16, fill, fcnt);
				break;
			case 'k':
				con->fgcol = va_arg(ap, u32);
				break;
			case 'K':
				con->bgcol = va_arg(ap, u32);
				con->fillbg = fcnt;
				break;
			case '%':
				gfx_putc(con, '%');
				break;
			case '\0':
				goto out;
			default:
				gfx_putc(con, '%');
				gfx_putc(con, *fmt);
				break;
			}
		}
		else
			gfx_putc(con, *fmt);
		fmt++;
	}

	out:
	va_end(ap);

	gfx_putc(con, '\n');
}

void gfx_hexdump(gfx_con_t *con, u32 base, const u8 *buf, u32 len)
{
	for(u32 i = 0; i < len; i++)
	{
		if(i % 0x10 == 0)
		{
			if(i != 0)
			{
				gfx_puts(con, "| ");
				for(u32 j = 0; j < 0x10; j++)
				{
					u8 c = buf[i - 0x10 + j];
					if(c >= 32 && c < 128)
						gfx_putc(con, c);
					else
						gfx_putc(con, '.');
				}
				gfx_putc(con, '\n');
			}
			gfx_printf(con, "%08x: ", base + i);
		}
		gfx_printf(con, "%02x ", buf[i]);
	}
	gfx_putc(con, '\n');
}

static int abs(int x)
{
	if (x < 0)
		return -x;
	return x;
}

void gfx_set_pixel(gfx_ctxt_t *ctxt, u32 x, u32 y, u32 color)
{
	ctxt->fb[x + y * ctxt->stride] = color;
}

void gfx_line(gfx_ctxt_t *ctxt, int x0, int y0, int x1, int y1, u32 color)
{
	int dx = abs(x1-x0), sx = x0 < x1 ? 1 : -1;
	int dy = abs(y1-y0), sy = y0 < y1 ? 1 : -1; 
	int err = (dx > dy ? dx : -dy) / 2, e2;

	while (1)
	{
		gfx_set_pixel(ctxt, x0, y0, color);
		if (x0 == x1 && y0 == y1)
			break;
		e2 = err;
		if (e2 >-dx) { err -= dy; x0 += sx; }
		if (e2 < dy) { err += dx; y0 += sy; }
	}
}
